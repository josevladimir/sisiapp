<app-sub-toolbar *ngIf="this.isAdmin | async"
    title="Indicador: {{this.Indicator.name}}"
    [backButton]="true"
    [editButton]="!(this.editMode | async)"
    [deleteButton]="this.DeleteBtn">
</app-sub-toolbar>

<app-sub-toolbar *ngIf="!(this.isAdmin | async)"
    title="Indicador: {{this.Indicator.name}}"
    [backButton]="true">
</app-sub-toolbar>

<div class="page-content">
    <div *ngIf="!(this.editMode | async); else EditMode">
        <mat-card class="pb-3">
            <mat-card-title class="font-weight-lighter">Información General</mat-card-title>
            <div class="row mb-3">
                <div class="col-sm-6">
                    <div><small class="label">Nombre del Indicador</small></div>
                    <div>{{this.Indicator.name}}</div>
                </div>
                <div class="col-sm-6">
                    <div><small>Tipo de Indicador</small></div>
                    <div>{{this.Indicator.type}}</div>
                </div>
            </div>
            <mat-divider *ngIf="this.Indicator.type == 'Compuesto'"></mat-divider>
            <div class="label">
                <div *ngIf="this.Indicator.type == 'Compuesto' && this.Indicator.antiquity_diff"><small>Este indicador <b>DIFERENCIA</b> entre organizaciones nuevas y antiguas</small></div>
                <ng-template>
                    <div><small>Este indicador <b>NO DIFERENCIA</b> entre organizaciones nuevas y antiguas</small></div>
                </ng-template>
            </div>
        </mat-card>
    
        <!--Parámetros Indicador Simple-->
        <div class="mt-4" *ngIf="this.Indicator.type == 'Simple'; else EsquemaCompuesto">
            <mat-card>
                <mat-card-title class="font-weight-lighter">Descripción del Indicador</mat-card-title>
                <div class="row">
                    <div class="col-sm-12">
                        <div class="label">{{this.Indicator.description}}</div>
                    </div>
                </div>
            </mat-card>
            <mat-card class="mt-4 mb-4">
                <mat-card-title class="font-weight-lighter">Parámetros del Indicador</mat-card-title>
                <div class="row mb-2">
                    <div class="col-sm-3">
                        <div class="full-width text-sm-center">Nombre</div>
                    </div>
                    <div class="col-sm-3">
                        <div class="full-width text-sm-center">Frecuencia</div>
                    </div>
                    <div class="col-sm-3">
                        <div class="full-width text-sm-center">Acumulativo</div>
                    </div>
                    <div class="col-sm-3">
                        <div class="full-width text-sm-center">Unidad</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-3">
                        <div class="table-box p-1 font-weight-lighter text-center">{{this.Indicator.parameters_schema[0].name}}</div>
                    </div>
                    <div class="col-sm-3">
                        <div class="table-box p-1 font-weight-lighter text-center">{{this.Indicator.parameters_schema[0].frequency}}</div>
                    </div>
                    <div class="col-sm-3">
                        <div class="table-box p-1 font-weight-lighter text-center">{{this.Indicator.parameters_schema[0].isAcum}}</div>
                    </div>
                    <div class="col-sm-3">
                        <div class="table-box p-1 font-weight-lighter text-center">{{this.Indicator.parameters_schema[0].unit}}</div>
                    </div>
                </div>
            </mat-card>
        </div>
    
        <!--Esquema Indicador Compuesto-->
        <ng-template #EsquemaCompuesto>
            <mat-card class="mt-4">
                <mat-card-title class="font-weight-lighter">Esquema de la Ficha</mat-card-title>
                <div class="row">
                    <div class="col-sm-4">
                        <div class="full-width text-sm-center">Nombre</div>
                    </div>
                    <div class="col-sm-4">
                        <div class="full-width text-sm-center">Frecuencia</div>
                    </div>
                    <div class="col-sm-4">
                        <div class="full-width text-sm-center">Unidad</div>
                    </div>
                </div>
                <div *ngFor="let field of this.Indicator.record_schema">
                    <div class="row mb-3">
                        <div class="col-sm-4">
                            <div class="table-box p-1 font-weight-lighter text-center">{{field.name}}</div>
                        </div>
                        <div class="col-sm-4">
                            <div class="table-box p-1 font-weight-lighter text-center">{{field.frequency}}</div>
                        </div>
                        <div class="col-sm-4">
                            <div class="table-box p-1 font-weight-lighter text-center">{{field.unit}}</div>
                        </div>
                    </div>
                </div>
            </mat-card>
    
            <!--Parámetros Indicador Compuesto Sin Diferenciación-->
            <mat-card class="mt-4" *ngIf="!this.Indicator.antiquity_diff; else ConDiferenciacion">
                <mat-card-title class="font-weight-lighter">Parámetros del Indicador</mat-card-title>
                <div class="row mb-2">
                    <div class="col-sm-3">
                        <div class="full-width text-sm-center">Nombre</div>
                    </div>
                    <div class="col-sm-3">
                        <div class="full-width text-sm-center">Ponderación (%)</div>
                    </div>
                    <div class="col-sm-3">
                        <div class="full-width text-sm-center">Acumulativo</div>
                    </div>
                    <div class="col-sm-3">
                        <div class="full-width text-sm-center">Unidad</div>
                    </div>
                </div>
                <div class="mb-1" *ngFor="let parameter of this.Indicator.parameters_schema">
                    <div class="row mb-3">
                        <div class="col-sm-3">
                            <div class="table-box p-1 font-weight-lighter text-center">{{parameter.name}}</div>
                        </div>
                        <div class="col-sm-3">
                            <div class="table-box p-1 font-weight-lighter text-center">{{parameter.weighing[0].weight}}</div>
                        </div>
                        <div class="col-sm-3">
                            <div class="table-box p-1 font-weight-lighter text-center">{{parameter.isAcum}}</div>
                        </div>
                        <div class="col-sm-3">
                            <div class="table-box p-1 font-weight-lighter text-center">{{parameter.unit}}</div>
                        </div>
                    </div>
                </div>
            </mat-card>
    
            <ng-template #ConDiferenciacion>
                <mat-card class="mt-4">
                    <mat-card-title class="font-weight-lighter">Parámetros del Indicador</mat-card-title>
                    <div class="row mb-2">
                        <div class="col-sm-3">
                            <div class="full-width text-sm-center">Nombre</div>
                        </div>
                        <div class="col-sm-3">
                            <div class="full-width text-sm-center">Ponderación (%)</div>
                        </div>
                        <div class="col-sm-3">
                            <div class="full-width text-sm-center">Acumulativo</div>
                        </div>
                        <div class="col-sm-3">
                            <div class="full-width text-sm-center">Unidad</div>
                        </div>
                    </div>
                    <div class="mb-1"*ngFor="let parameter of this.Indicator.parameters_schema">
                        <div class="row mb-3">
                            <div class="col-sm-3">
                                <div class="table-box p-1 font-weight-lighter text-center">{{parameter.name}}</div>
                            </div>
                            <div class="col-sm-3">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <div class="table-box p-1 font-weight-lighter text-center">{{parameter.weighing[0].older}}</div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="table-box p-1 font-weight-lighter text-center">{{parameter.weighing[0].newer}}</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-3">
                                <div class="table-box p-1 font-weight-lighter text-center">{{parameter.isAcum}}</div>
                            </div>
                            <div class="col-sm-3">
                                <div class="table-box p-1 font-weight-lighter text-center">{{parameter.unit}}</div>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-3"></div>
                        <div class="col-sm-3">
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="font-weight-lighter full-width text-center">Antigua</div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="font-weight-lighter full-width text-center">Nueva</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3"></div>
                        <div class="col-sm-3"></div>
                    </div>
                </mat-card>
            </ng-template>
    
            <!--Definición de los Parámetros-->
            <mat-card class="mt-4 mb-4">
                <mat-card-title class="font-weight-lighter">Definición de los Parámetros</mat-card-title>
                <div class="definition-box mt-2 mb-4">
                    <mat-list> 
                        <span class="definition-column-label">Parámetro</span>
                        <li *ngFor="let parameter of this.Indicator.parameters_schema; let i = index">
                            <button mat-flat-button type="button" *ngIf="this.ParameterSelected != null && i == this.ParameterSelected; else NoSelected" (click)="this.ParameterSelected = i" class="font-weight-lighter selected-parameter full-width">{{parameter.name}}</button>
                            <ng-template #NoSelected>
                                <button mat-flat-button type="button" (click)="this.ParameterSelected = i" class="font-weight-lighter full-width">{{parameter.name}}</button>
                            </ng-template>
                        </li>
                    </mat-list>
                    <mat-list class="definition-column">
                        <span class="definition-column-label">Definición del Parámetro</span>
                        <div class="definition-space">
                            <div *ngIf="this.ParameterSelected != null">
                                <label class="p-1 font-weight-lighter" *ngFor="let field of this.Indicator.parameters_schema[this.ParameterSelected].definition">
                                    {{field.value}}
                                </label>
                            </div>
                        </div>
                    </mat-list>
                </div>
            </mat-card>
    
        </ng-template>
    </div>



    <!--


        Formulario


    -->




    <ng-template #EditMode>
        <form [formGroup]="this.IndicatorForm" (ngSubmit)="saveIndicator()">
            <mat-card class="pb-3">
                <mat-card-title class="font-weight-lighter">Información General</mat-card-title>
                <div class="row">
                    <div class="col-sm-6">
                        <mat-form-field class="full-width">
                            <input matInput type="text" formControlName="name" placeholder="Nombre del Indicador">
                            <mat-error *ngIf="this.IndicatorForm.controls.name.errors?.required">Este campo es obligatorio.</mat-error>
                            <mat-error *ngIf="!this.IndicatorForm.controls.name.errors?.required && this.IndicatorForm.controls.name.errors?.isBlank">Este campo no puede quedar en blanco.</mat-error>
                        </mat-form-field>
                    </div>
                    <div class="col-sm-6">
                        <mat-form-field class="full-width">
                            <mat-label>Tipo de Indicador</mat-label>
                            <mat-select formControlName="type" disabled>
                                <mat-option value="Simple">Simple</mat-option>
                                <mat-option value="Compuesto">Compuesto</mat-option>
                            </mat-select>
                        </mat-form-field>
                    </div>
                </div>
                <div class="flex mt-3 justify-content-center">
                    <mat-checkbox *ngIf="this.Indicator.type == 'Compuesto'" formControlName="antiquity_diff">Diferenciar entre organizaciones nuevas y antiguas</mat-checkbox>
                </div>
            </mat-card>
        
            <!--Parámetros Indicador Simple-->
            <div class="mt-4" *ngIf="this.Indicator.type == 'Simple'; else EsquemaCompuesto">
                <mat-card>
                    <mat-card-title class="font-weight-lighter">Descripción del Indicador</mat-card-title>
                    <div class="row">
                        <div class="col-sm-12">
                            <mat-form-field class="full-width">
                                <textarea matInput #input formControlName="description" maxlength="250" placeholder="Escriba una breve descripción del Indicador Simple aquí..."></textarea>
                                <mat-error *ngIf="this.IndicatorForm.controls.description.errors?.required">Este campo es obligatorio.</mat-error>
                                <mat-error *ngIf="!this.IndicatorForm.controls.description.errors?.required && this.IndicatorForm.controls.description.errors?.isBlank">Este campo no puede quedar en blanco.</mat-error>
                                <mat-hint align="end">{{input.value?.length || 0}}/250</mat-hint>
                            </mat-form-field>
                        </div>
                    </div>
                </mat-card>
                <mat-card class="mt-4 mb-4" formArrayName="parameters_schema">
                    <mat-card-title class="font-weight-lighter">Parámetros del Indicador</mat-card-title>
                    <div class="row mb-2">
                        <div class="col-sm-3">
                            <div class="full-width text-sm-center">Nombre</div>
                        </div>
                        <div class="col-sm-3">
                            <div class="full-width text-sm-center">Frecuencia</div>
                        </div>
                        <div class="col-sm-3">
                            <div class="full-width text-sm-center">Acumulativo</div>
                        </div>
                        <div class="col-sm-3">
                            <div class="full-width text-sm-center">Unidad</div>
                        </div>
                    </div>
                    <div class="row" [formGroupName]="0">
                        <div class="col-sm-3">
                            <input type="text" formControlName="name" class="schema-input full-width">
                        </div>
                        <div class="col-sm-3">
                            <mat-select class="schema-input full-width" formControlName="frequency">
                                <mat-option value="Mensual">Mensual</mat-option>
                                <mat-option value="Trimestral">Trimestral</mat-option>
                                <mat-option value="Semestral">Semestral</mat-option>
                            </mat-select>
                        </div>
                        <div class="col-sm-3">
                            <mat-select class="schema-input full-width" formControlName="isAcum">
                                <mat-option value="Si">Si</mat-option>
                                <mat-option value="No">No</mat-option>
                            </mat-select>
                        </div>
                        <div class="col-sm-3">
                            <mat-select class="schema-input full-width" formControlName="unit">
                                <mat-option value="Número">Número</mat-option>
                                <mat-option value="Moneda">Moneda</mat-option>
                                <mat-option value="Porcentaje">Porcentaje</mat-option>
                            </mat-select>
                        </div>
                    </div>
                </mat-card>
            </div>
        
            <!--Esquema Indicador Compuesto-->
            <ng-template #EsquemaCompuesto>
                <mat-card class="mt-4">
                    <mat-card-title class="font-weight-lighter">Esquema de la Ficha</mat-card-title>
                    <div class="row">
                        <div class="col-sm-4">
                            <div class="full-width text-sm-center">Nombre</div>
                        </div>
                        <div class="col-sm-4">
                            <div class="full-width text-sm-center">Frecuencia</div>
                        </div>
                        <div class="col-sm-4">
                            <div class="full-width text-sm-center">Unidad</div>
                        </div>
                    </div>
                    <div formArrayName="record_schema" *ngFor="let field of this.IndicatorForm.controls.record_schema['controls']; let i = index">
                        <div class="row mb-3" [formGroupName]="i">
                            <div class="col-sm-4">
                                <input type="text" formControlName="name" class="schema-input full-width">
                            </div>
                            <div class="col-sm-4">
                                <mat-select class="schema-input full-width" formControlName="frequency">
                                    <mat-option value="Mensual">Mensual</mat-option>
                                    <mat-option value="Trimestral">Trimestral</mat-option>
                                    <mat-option value="Semestral">Semestral</mat-option>
                                </mat-select>
                            </div>
                            <div class="col-sm-4">
                                <mat-select class="schema-input full-width" formControlName="unit">
                                    <mat-option value="Número">Número</mat-option>
                                    <mat-option value="Moneda">Moneda</mat-option>
                                    <mat-option value="Porcentaje">Porcentaje</mat-option>
                                </mat-select>
                            </div>
                        </div>
                    </div>
                    <mat-card-actions>
                        <div class="flex mb-4">
                            <span class="fill-remaining-space"></span>
                            <button mat-raised-button color="primary" type="button" (click)="this.addField()"><mat-icon>add</mat-icon> AGREGAR</button>
                        </div>
                    </mat-card-actions>
                </mat-card>
        
                <!--Parámetros Indicador Compuesto Sin Diferenciación-->
                <mat-card class="mt-4" *ngIf="!this.IndicatorForm.controls.antiquity_diff.value; else ConDiferenciacion">
                    <mat-card-title class="font-weight-lighter">Parámetros del Indicador</mat-card-title>
                    <div class="row mb-2">
                        <div class="col-sm-3">
                            <div class="full-width text-sm-center">Nombre</div>
                        </div>
                        <div class="col-sm-3">
                            <div class="full-width text-sm-center">Ponderación (%)</div>
                        </div>
                        <div class="col-sm-3">
                            <div class="full-width text-sm-center">Acumulativo</div>
                        </div>
                        <div class="col-sm-3">
                            <div class="full-width text-sm-center">Unidad</div>
                        </div>
                    </div>
                    <div class="mb-1" formArrayName="parameters_schema" *ngFor="let parameter of this.IndicatorForm.controls.parameters_schema['controls']; let i = index">
                        <div class="row mb-3" [formGroupName]="i">
                            <div class="col-sm-3">
                                <input type="text" formControlName="name" class="schema-input full-width">
                            </div>
                            <div class="col-sm-3" formArrayName="weighing">
                                <div [formGroupName]="0">
                                    <input type="number" formControlName="weight" class="schema-input full-width">
                                </div>
                            </div>
                            <div class="col-sm-3">
                                <mat-select formControlName="isAcum" class="schema-input full-width">
                                    <mat-option value="Si">Sí</mat-option>
                                    <mat-option value="No">No</mat-option>
                                </mat-select>
                            </div>
                            <div class="col-sm-3">
                                <mat-select formControlName="unit" class="schema-input full-width">
                                    <mat-option value="Número">Número</mat-option>
                                    <mat-option value="Moneda">Moneda</mat-option>
                                    <mat-option value="Porcentaje">Porcentaje</mat-option>
                                </mat-select>
                            </div>
                        </div>
                    </div>
                    <mat-card-actions>
                        <div class="flex mb-4">
                            <span class="fill-remaining-space"></span>
                            <button mat-raised-button color="primary" type="button" (click)="this.addParameter()"><mat-icon>add</mat-icon> AGREGAR</button>
                        </div>
                    </mat-card-actions>
                </mat-card>
        
                <ng-template #ConDiferenciacion>
                    <mat-card class="mt-4">
                        <mat-card-title class="font-weight-lighter">Parámetros del Indicador</mat-card-title>
                        <div class="row mb-2">
                            <div class="col-sm-3">
                                <div class="full-width text-sm-center">Nombre</div>
                            </div>
                            <div class="col-sm-3">
                                <div class="full-width text-sm-center">Ponderación (%)</div>
                            </div>
                            <div class="col-sm-3">
                                <div class="full-width text-sm-center">Acumulativo</div>
                            </div>
                            <div class="col-sm-3">
                                <div class="full-width text-sm-center">Unidad</div>
                            </div>
                        </div>
                        <div class="mb-1" formArrayName="parameters_schema" *ngFor="let parameter of this.IndicatorForm.controls.parameters_schema['controls']; let i = index">
                            <div class="row mb-3" [formGroupName]="i">
                                <div class="col-sm-3">
                                    <input type="text" formControlName="name" class="schema-input full-width">
                                </div>
                                <div class="col-sm-3" formArrayName="weighing">
                                    <div class="row" [formGroupName]="0">
                                        <div class="col-sm-6">
                                            <input type="number" formControlName="older" class="schema-input full-width">
                                        </div>
                                        <div class="col-sm-6">
                                            <input type="number" formControlName="newer" class="schema-input full-width">
                                        </div>
                                    </div>
                                </div>
                                <div class="col-sm-3">
                                    <mat-select formControlName="isAcum" class="schema-input full-width">
                                        <mat-option value="Si">Sí</mat-option>
                                        <mat-option value="No">No</mat-option>
                                    </mat-select>
                                </div>
                                <div class="col-sm-3">
                                    <mat-select formControlName="unit" class="schema-input full-width">
                                        <mat-option value="Número">Número</mat-option>
                                        <mat-option value="Moneda">Moneda</mat-option>
                                        <mat-option value="Porcentaje">Porcentaje</mat-option>
                                    </mat-select>
                                </div>
                            </div>
                        </div>
                        <div class="row">
                            <div class="col-sm-3"></div>
                            <div class="col-sm-3">
                                <div class="row">
                                    <div class="col-sm-6">
                                        <div class="font-weight-lighter full-width text-center">Antigua</div>
                                    </div>
                                    <div class="col-sm-6">
                                        <div class="font-weight-lighter full-width text-center">Nueva</div>
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-3"></div>
                            <div class="col-sm-3"></div>
                        </div>
                        <mat-card-actions>
                            <div class="flex mb-4">
                                <span class="fill-remaining-space"></span>
                                <button mat-raised-button color="primary" type="button" (click)="this.addParameter()"><mat-icon>add</mat-icon> AGREGAR</button>
                            </div>
                        </mat-card-actions>
                    </mat-card>
                </ng-template>
        
                <!--Definición de los Parámetros-->
                <mat-card class="mt-4 mb-4">
                    <mat-card-title class="font-weight-lighter">Definición de los Parámetros</mat-card-title>
                    <div class="definition-box mt-2">
                        <mat-list> 
                            <span class="definition-column-label">Parámetro</span>
                            <li *ngFor="let parameter of this.IndicatorForm.controls.parameters_schema['controls']; let i = index">
                                <button mat-flat-button type="button" *ngIf="this.ParameterSelected && i == this.ParameterSelected; else NoSelected" (click)="this.ParameterSelected = i" class="font-weight-lighter selected-parameter full-width">{{parameter['controls'].name.value}}</button>
                                <ng-template #NoSelected>
                                    <button mat-flat-button type="button" (click)="this.ParameterSelected = i" class="font-weight-lighter full-width">{{parameter['controls'].name.value}}</button>
                                </ng-template>
                            </li>
                        </mat-list>
                        <mat-list>
                            <span class="definition-column-label">Campos de la Ficha:</span>
                            <div *ngIf="this.ParameterSelected != null">
                                <button mat-button type="button" class="font-weight-lighter full-width" (dblclick)="addFieldToDefinition(field['controls'].name.value)" *ngFor="let field of this.IndicatorForm.controls.record_schema['controls']">{{field['controls'].name.value}}</button>
                            </div>
                        </mat-list>
                    </div>
                    <div class="editor-box">
                        <mat-list class="definition-column">
                            <span class="definition-column-label">Definición del Parámetro</span>
                            <div class="definition-space">
                                <mat-chip-list *ngIf="this.ParameterSelected != null" #chipList aria-label="Fields selection">
                                    <div *ngFor="let field of this.IndicatorForm.controls.parameters_schema['controls'][this.ParameterSelected].controls.definition.controls; let i = index">
                                        <div>
                                            <mat-chip *ngIf="field.get('type').value == 'field' || field.get('type').value == 'normal'" [selectable]="true" [removable]="true" (removed)="remove(i)">
                                                <span>{{field.get('value').value}}</span>
                                                <mat-icon matChipRemove *ngIf="true">cancel</mat-icon>
                                            </mat-chip>

                                            <div *ngIf="field.get('type').value == '%-number'" class="my-chip">
                                                <div>% si <input type="number" width="100px" [formControl]="field.get('value')" placeholder="número"> es el 100%</div>
                                                <mat-icon (click)="this.remove(i)" *ngIf="true">cancel</mat-icon>
                                            </div>
        
                                            <div *ngIf="field.get('type').value == 'number'" class="my-chip">
                                                <div><input type="number" width="100px" [formControl]="field.get('value')" placeholder="número"></div>
                                                <mat-icon (click)="this.remove(i)" *ngIf="true">cancel</mat-icon>
                                            </div>
                                        </div>
                                    </div>
                                </mat-chip-list>
                            </div>
                            <div class="botonera">
                                <button type="button" mat-raised-button (click)="addOperator('+')" class="botonera-btn mr-1">+</button>
                                <button type="button" mat-raised-button (click)="addOperator('-')" class="botonera-btn mr-1">-</button>
                                <button type="button" mat-raised-button (click)="addOperator('*')" class="botonera-btn mr-1">*</button>
                                <button type="button" mat-raised-button (click)="addOperator('/')" class="botonera-btn mr-1">/</button>
                                <button type="button" mat-raised-button (click)="addOperator('(')" class="botonera-btn mr-1">(</button>
                                <button type="button" mat-raised-button (click)="addOperator(')')" class="botonera-btn mr-1">)</button>
                                <button type="button" mat-raised-button (click)="addOperator('*100%')" class="botonera-btn mr-1">*100%</button>
                                <button type="button" mat-raised-button (click)="addOperator('number')" class="botonera-btn mr-1">número</button>
                                <button type="button" mat-raised-button (click)="addOperator('%-number')" class="botonera-btn">% de número</button>
                            </div>
                        </mat-list>
                    </div>
                </mat-card>
        
            </ng-template>
        
            <app-button-group class="mt-4" [formStatus]="false" (cancel)="cancel()" (save)="saveIndicator()"></app-button-group>
        
        </form>
    </ng-template>
</div> 