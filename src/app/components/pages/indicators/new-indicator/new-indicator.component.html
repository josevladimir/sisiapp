<app-sub-toolbar
    title="Nuevo Indicador"
    [backButton]="true"
    [addButton]="false">
</app-sub-toolbar>

<div class="page-content">
    <form [formGroup]="this.indicatorForm" (ngSubmit)="saveIndicator()">
        <mat-card class="pb-3">
            <mat-card-title class="font-weight-lighter">Información General</mat-card-title>
            <div class="row">
                <div class="col-sm-6">
                    <mat-form-field class="full-width">
                        <input matInput type="text" formControlName="name" placeholder="Nombre del Indicador">
                        <mat-error *ngIf="this.nameCtrl.errors?.required">Este campo es obligatorio.</mat-error>
                        <mat-error *ngIf="!this.nameCtrl.errors?.required && this.nameCtrl.errors?.isBlank">Este campo no puede quedar en blanco.</mat-error>
                    </mat-form-field>
                </div>
                <div class="col-sm-6">
                    <mat-form-field class="full-width">
                        <mat-label>Tipo de Indicador</mat-label>
                        <mat-select formControlName="type" (valueChange)="changeType($event)">
                            <mat-option value="Simple">Simple</mat-option>
                            <mat-option value="Compuesto">Compuesto</mat-option>
                        </mat-select>
                    </mat-form-field>
                </div>
            </div>
            <div class="flex mt-3 justify-content-center">
                <mat-checkbox *ngIf="this.typeCtrl.value == 'Compuesto'" formControlName="antiquity_diff">Diferenciar entre organizaciones nuevas y antiguas</mat-checkbox>
            </div>
        </mat-card>

        <!--Parámetros Indicador Simple-->
        <div class="mt-4" *ngIf="this.typeCtrl.value == 'Simple'; else EsquemaCompuesto">
            <mat-card>
                <mat-card-title class="font-weight-lighter">Descripción del Indicador</mat-card-title>
                <div class="row">
                    <div class="col-sm-12">
                        <mat-form-field class="full-width">
                            <textarea matInput #input [formControl]="this.descriptionCtrl" maxlength="250" placeholder="Escriba una breve descripción del Indicador Simple aquí..."></textarea>
                            <mat-error *ngIf="this.descriptionCtrl.errors?.required">Este campo es obligatorio.</mat-error>
                            <mat-error *ngIf="!this.descriptionCtrl.errors?.required && this.descriptionCtrl.errors?.isBlank">Este campo no puede quedar en blanco.</mat-error>
                            <mat-hint align="end">{{input.value?.length || 0}}/250</mat-hint>
                        </mat-form-field>
                    </div>
                </div>
            </mat-card>
            <mat-card class="mt-4 mb-4" formGroupName="parameters_schema">
                <mat-card-title class="font-weight-lighter">Parámetros del Indicador</mat-card-title>
                <div class="row mb-2">
                    <div class="col-sm-3">
                        <div class="full-width text-sm-center">Nombre</div>
                    </div>
                    <div class="col-sm-3">
                        <div class="full-width text-sm-center">Frecuencia</div>
                    </div>
                    <div class="col-sm-3">
                        <div class="full-width text-sm-center">Acumulativo</div>
                    </div>
                    <div class="col-sm-3">
                        <div class="full-width text-sm-center">Unidad</div>
                    </div>
                </div>
                <div class="row">
                    <div class="col-sm-3">
                        <input type="text" formControlName="name" class="schema-input full-width">
                    </div>
                    <div class="col-sm-3">
                        <mat-select class="schema-input full-width" formControlName="frequency">
                            <mat-option value="Mensual">Mensual</mat-option>
                            <mat-option value="Trimestral">Trimestral</mat-option>
                            <mat-option value="Semestral">Semestral</mat-option>
                        </mat-select>
                    </div>
                    <div class="col-sm-3">
                        <mat-select class="schema-input full-width" formControlName="isAcum">
                            <mat-option value="Si">Si</mat-option>
                            <mat-option value="No">No</mat-option>
                        </mat-select>
                    </div>
                    <div class="col-sm-3" (click)="showData()">
                        <mat-select class="schema-input full-width" formControlName="unit">
                            <mat-option value="Número">Número</mat-option>
                            <mat-option value="Moneda">Moneda</mat-option>
                            <mat-option value="Porcentaje">Porcentaje</mat-option>
                        </mat-select>
                    </div>
                </div>
            </mat-card>
        </div>

        <!--Esquema Indicador Compuesto-->
        <ng-template #EsquemaCompuesto>
            <mat-card class="mt-4">
                <mat-card-title class="font-weight-lighter">Esquema de la Ficha</mat-card-title>
                <div class="row">
                    <div class="col-sm-4">
                        <div class="full-width text-sm-center">Nombre</div>
                    </div>
                    <div class="col-sm-4">
                        <div class="full-width text-sm-center">Frecuencia</div>
                    </div>
                    <div class="col-sm-4">
                        <div class="full-width text-sm-center">Unidad</div>
                    </div>
                </div>
                <div formArrayName="record_schema" *ngFor="let field of this.record_schemaCtrl.controls; let i = index">
                    <div class="row mb-3" [formGroupName]="i">
                        <div class="col-sm-4">
                            <input type="text" formControlName="name" class="schema-input full-width">
                        </div>
                        <div class="col-sm-4">
                            <mat-select class="schema-input full-width" formControlName="frequency">
                                <mat-option value="Mensual">Mensual</mat-option>
                                <mat-option value="Trimestral">Trimestral</mat-option>
                                <mat-option value="Semestral">Semestral</mat-option>
                            </mat-select>
                        </div>
                        <div class="col-sm-4">
                            <mat-select class="schema-input full-width" formControlName="unit">
                                <mat-option value="Número">Número</mat-option>
                                <mat-option value="Moneda">Moneda</mat-option>
                                <mat-option value="Porcentaje">Porcentaje</mat-option>
                            </mat-select>
                        </div>
                    </div>
                </div>
                <mat-card-actions>
                    <div class="flex mb-4">
                        <span class="fill-remaining-space"></span>
                        <button mat-raised-button color="primary" type="button" (click)="this.addField()"><mat-icon>add</mat-icon> AGREGAR</button>
                    </div>
                </mat-card-actions>
            </mat-card>

            <!--Parámetros Indicador Compuesto Sin Diferenciación-->
            <mat-card class="mt-4" *ngIf="!this.antiquity_diffCtrl.value; else ConDiferenciacion">
                <mat-card-title class="font-weight-lighter">Parámetros del Indicador</mat-card-title>
                <div class="row mb-2">
                    <div class="col-sm-3">
                        <div class="full-width text-sm-center">Nombre</div>
                    </div>
                    <div class="col-sm-3">
                        <div class="full-width text-sm-center">Ponderación (%)</div>
                    </div>
                    <div class="col-sm-3">
                        <div class="full-width text-sm-center">Acumulativo</div>
                    </div>
                    <div class="col-sm-3">
                        <div class="full-width text-sm-center">Unidad</div>
                    </div>
                </div>
                <div class="mb-1" formArrayName="parameters_schema" *ngFor="let parameter of this.parameterCompuesto.controls; let i = index">
                    <div class="row mb-3" [formGroupName]="i">
                        <div class="col-sm-3">
                            <input type="text" formControlName="name" class="schema-input full-width">
                        </div>
                        <div class="col-sm-3" formGroupName="weighing">
                            <input type="number" formControlName="weight" class="schema-input full-width">
                        </div>
                        <div class="col-sm-3">
                            <mat-select formControlName="isAcum" class="schema-input full-width">
                                <mat-option value="Sí">Sí</mat-option>
                                <mat-option value="No">No</mat-option>
                            </mat-select>
                        </div>
                        <div class="col-sm-3">
                            <mat-select formControlName="unit" class="schema-input full-width">
                                <mat-option value="Número">Número</mat-option>
                                <mat-option value="Moneda">Moneda</mat-option>
                                <mat-option value="Porcentaje">Porcentaje</mat-option>
                            </mat-select>
                        </div>
                    </div>
                </div>
                <mat-card-actions>
                    <div class="flex mb-4 mt-4">
                        <span class="fill-remaining-space"></span>
                        <button mat-raised-button color="primary" type="button" (click)="this.addParameter()"><mat-icon>add</mat-icon> AGREGAR</button>
                    </div>
                </mat-card-actions>
            </mat-card>

            <ng-template #ConDiferenciacion>
                <mat-card class="mt-4">
                    <mat-card-title class="font-weight-lighter">Parámetros del Indicador</mat-card-title>
                    <div class="row mb-2">
                        <div class="col-sm-3">
                            <div class="full-width text-sm-center">Nombre</div>
                        </div>
                        <div class="col-sm-3">
                            <div class="full-width text-sm-center">Ponderación (%)</div>
                        </div>
                        <div class="col-sm-3">
                            <div class="full-width text-sm-center">Acumulativo</div>
                        </div>
                        <div class="col-sm-3">
                            <div class="full-width text-sm-center">Unidad</div>
                        </div>
                    </div>
                    <div class="mb-1" formArrayName="parameters_schema" *ngFor="let parameter of this.parameterCompuesto.controls; let i = index">
                        <div class="row mb-3" [formGroupName]="i">
                            <div class="col-sm-3">
                                <input type="text" formControlName="name" class="schema-input full-width">
                            </div>
                            <div class="col-sm-3">
                                <div class="row" formGroupName="weighing">
                                    <div class="col-sm-6">
                                        <input type="number" formControlName="older" class="schema-input full-width">
                                    </div>
                                    <div class="col-sm-6">
                                        <input type="number" formControlName="newer" class="schema-input full-width">
                                    </div>
                                </div>
                            </div>
                            <div class="col-sm-3">
                                <mat-select formControlName="isAcum" class="schema-input full-width">
                                    <mat-option value="Si">Sí</mat-option>
                                    <mat-option value="No">No</mat-option>
                                </mat-select>
                            </div>
                            <div class="col-sm-3">
                                <mat-select formControlName="unit" class="schema-input full-width">
                                    <mat-option value="Número">Número</mat-option>
                                    <mat-option value="Moneda">Moneda</mat-option>
                                    <mat-option value="Porcentaje">Porcentaje</mat-option>
                                </mat-select>
                            </div>
                        </div>
                    </div>
                    <div class="row">
                        <div class="col-sm-3"></div>
                        <div class="col-sm-3">
                            <div class="row">
                                <div class="col-sm-6">
                                    <div class="font-weight-lighter full-width text-center">Antigua</div>
                                </div>
                                <div class="col-sm-6">
                                    <div class="font-weight-lighter full-width text-center">Nueva</div>
                                </div>
                            </div>
                        </div>
                        <div class="col-sm-3"></div>
                        <div class="col-sm-3"></div>
                    </div>
                    <mat-card-actions>
                        <div class="flex mb-4 mt-4">
                            <span class="fill-remaining-space"></span>
                            <button mat-raised-button color="primary" type="button" (click)="this.addParameter()"><mat-icon>add</mat-icon> AGREGAR</button>
                        </div>
                    </mat-card-actions>
                </mat-card>
            </ng-template>

            <!--Definición de los Parámetros-->
            <mat-card class="mt-4 mb-4">
                <mat-card-title class="font-weight-lighter">Definición de los Parámetros</mat-card-title>
                <div class="definition-box mt-2 mb-4">
                    <mat-list> 
                        <span class="definition-column-label">Parámetro</span>
                        <li *ngFor="let parameter of this.parameterCompuesto.controls; let i = index">
                            <button mat-flat-button type="button" *ngIf="this.parameterSelected && i == this.parameterSelected; else NoSelected" (click)="this.parameterSelected = i" class="font-weight-lighter selected-parameter full-width">{{parameter['controls'].name.value}}</button>
                            <ng-template #NoSelected>
                                <button mat-flat-button type="button" (click)="this.parameterSelected = i" class="font-weight-lighter full-width">{{parameter['controls'].name.value}}</button>
                            </ng-template>
                        </li>
                    </mat-list>
                    <mat-list>
                        <span class="definition-column-label">Campos de la Ficha:</span>
                        <div *ngIf="this.parameterSelected != null">
                            <button mat-button type="button" class="font-weight-lighter full-width" (dblclick)="addFieldToDefinition(field['controls'].name.value)" *ngFor="let field of this.record_schemaCtrl.controls">{{field['controls'].name.value}}</button>
                        </div>
                    </mat-list>
                    <mat-list class="definition-column">
                        <span class="definition-column-label">Definición del Parámetro</span>
                        <div class="definition-space">
                            <mat-chip-list *ngIf="this.parameterSelected != null" #chipList aria-label="Fields selection">
                                <mat-chip *ngFor="let field of this.parameterCompuesto.controls[this.parameterSelected].controls.definition.controls; let i = index" [selectable]="true" [removable]="true" (removed)="remove(i)">
                                    {{field.value}}<mat-icon matChipRemove *ngIf="true">cancel</mat-icon>
                                </mat-chip>
                            </mat-chip-list>
                        </div>
                        <div class="botonera flex justify-content-center">
                            <button type="button" (click)="addOperator('+')" class="botonera-btn mr-1">+</button>
                            <button type="button" (click)="addOperator('-')" class="botonera-btn mr-1">-</button>
                            <button type="button" (click)="addOperator('*')" class="botonera-btn mr-1">*</button>
                            <button type="button" (click)="addOperator('/')" class="botonera-btn mr-1">/</button>
                            <button type="button" (click)="addOperator('(')" class="botonera-btn mr-1">(</button>
                            <button type="button" (click)="addOperator(')')" class="botonera-btn mr-1">)</button>
                            <button type="button" (click)="addOperator('*100%')" class="botonera-btn">*100%</button>
                        </div>
                    </mat-list>
                </div>
            </mat-card>

        </ng-template>

        <app-button-group class="mt-4" [formStatus]="false" (cancel)="cancel()" (save)="saveIndicator()"></app-button-group>

    </form>
</div>